<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no, width=device-width">
    <title>å—äº¬æ–°ä¸œæ–¹æ ¡åŒºåˆ†å¸ƒåœ°å›¾ - åº•éƒ¨å¯¼èˆªç‰ˆ</title>
    <style>
        html, body, #container {
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
            font-family: "Microsoft YaHei", sans-serif;
            overflow: hidden; /* é˜²æ­¢é¡µé¢æ•´ä½“æ»šåŠ¨ */
        }

        /* --- ç­›é€‰é¢æ¿æ ·å¼ --- */
        .control-panel {
            position: absolute;
            top: 20px;
            left: 20px;
            background: white;
            padding: 0;
            border-radius: 8px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.3);
            z-index: 100;
            width: 160px;
            overflow: hidden;
            transition: height 0.3s ease;
        }

        .panel-header {
            padding: 12px 15px;
            background: #fff;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #eee;
        }

        .panel-header:hover { background-color: #f5f5f5; }
        .panel-header h4 { margin: 0; font-size: 15px; color: #333; }
        .toggle-icon { font-size: 12px; color: #999; transition: transform 0.3s; }
        .panel-content { padding: 10px; display: block; }

        .control-panel.collapsed .panel-content { display: none; }
        .control-panel.collapsed .panel-header { border-bottom: none; }
        .control-panel.collapsed .toggle-icon { transform: rotate(-90deg); }

        .filter-btn {
            display: block;
            width: 100%;
            padding: 6px 10px;
            margin-bottom: 6px;
            border: 1px solid #ddd;
            background: #f9f9f9;
            cursor: pointer;
            border-radius: 4px;
            text-align: left;
            transition: all 0.3s;
            font-size: 13px;
        }
        .filter-btn:last-child { margin-bottom: 0; }
        .filter-btn:hover, .filter-btn.active {
            background: #e6f7ff;
            border-color: #1890ff;
            color: #1890ff;
        }
        .filter-btn span { display: inline-block; width: 8px; height: 8px; border-radius: 50%; margin-right: 8px; }

        /* --- è·¯çº¿ç»“æœé¢æ¿ (ä¿®æ”¹ä¸ºåº•éƒ¨å¼¹å‡º) --- */
        #routePanel {
            position: absolute;
            bottom: 0;           /* é åº•éƒ¨ */
            left: 0;             /* é å·¦ */
            width: 100%;         /* å®½åº¦å æ»¡ */
            height: 45vh;        /* é»˜è®¤é«˜åº¦å å±å¹• 45% */
            max-height: 80vh;    /* æœ€å¤§é«˜åº¦ */
            background: white;
            box-shadow: 0 -2px 15px rgba(0,0,0,0.15); /* é˜´å½±å‘ä¸Š */
            border-radius: 16px 16px 0 0; /* åªæœ‰ä¸Šé¢ä¸¤ä¸ªè§’æ˜¯åœ†è§’ */
            z-index: 999;        /* ç¡®ä¿å±‚çº§å¤Ÿé«˜ */
            display: flex;       /* ä½¿ç”¨ Flex å¸ƒå±€æ–¹ä¾¿æ’ç‰ˆ */
            flex-direction: column;
            transform: translateY(105%); /* é»˜è®¤éšè—åœ¨å±å¹•ä¸‹æ–¹ */
            transition: transform 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94); /* å¹³æ»‘åŠ¨ç”» */
            box-sizing: border-box; 
        }

        /* æ¿€æ´»çŠ¶æ€ç±»ï¼Œç”¨äºæ˜¾ç¤ºé¢æ¿ */
        #routePanel.active {
            transform: translateY(0);
        }

        /* é¢æ¿å¤´éƒ¨ */
        .route-header {
            padding: 12px 15px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #fff;
            border-radius: 16px 16px 0 0;
            flex-shrink: 0; /* é˜²æ­¢å¤´éƒ¨è¢«å‹ç¼© */
        }

        .route-title {
            font-weight: bold;
            font-size: 16px;
            color: #333;
        }

        .close-route-btn {
            font-size: 24px;
            color: #999;
            cursor: pointer;
            line-height: 1;
            padding: 0 10px;
        }

        /* è·¯çº¿å†…å®¹åŒºåŸŸï¼Œå…è®¸æ»šåŠ¨ */
        #routeContent {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
            -webkit-overflow-scrolling: touch; /* ç§»åŠ¨ç«¯æ»šåŠ¨ä¼˜åŒ– */
        }
        
        /* éšè—é«˜å¾·é»˜è®¤çš„æ‰“è½¦æŒ‰é’® */
        #routePanel .amap-call { display: none; } 
        
        /* è°ƒæ•´é«˜å¾·è·¯çº¿è¯¦æƒ…çš„æ ·å¼ï¼Œä½¿å…¶é€‚åº”ç§»åŠ¨ç«¯ */
        .amap-lib-driving, .amap-lib-transfer, .amap-lib-walking {
            border: none !important;
            background: none !important;
        }

        /* --- æ ‡è®°ç‚¹æ ·å¼ --- */
        .css-marker {
            width: 16px; height: 16px; border-radius: 50%;
            box-shadow: 0 0 4px rgba(0,0,0,0.4); border: 2px solid white;
            position: relative; transition: all 0.2s ease; box-sizing: border-box;
            cursor: pointer; display: flex; justify-content: center; align-items: center;
        }
        .marker-label {
            position: absolute; top: -28px; left: 50%; transform: translateX(-50%);
            background-color: rgba(255, 255, 255, 0.95); padding: 4px 8px;
            border-radius: 4px; font-size: 12px; color: #333; white-space: nowrap;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2); border: 1px solid #eee;
            pointer-events: none; opacity: 0; visibility: hidden;
            transition: opacity 0.2s, visibility 0.2s; font-weight: bold; z-index: 10;
        }
        .marker-preview-img {
            position: absolute; bottom: 24px; left: 50%; transform: translateX(-50%) scale(0);
            width: 100px; height: 70px; object-fit: cover; border-radius: 6px;
            border: 2px solid white; box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            background: #fff; z-index: 20; transition: transform 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            transform-origin: bottom center; pointer-events: none;
        }
        .marker-arrow {
            position: absolute; bottom: -5px; left: 50%; transform: translateX(-50%);
            width: 0; height: 0; border-left: 5px solid transparent; border-right: 5px solid transparent;
            border-top-width: 5px; border-top-style: solid; opacity: 0; transition: opacity 0.2s;
        }
        .css-marker:hover { transform: scale(1.2) !important; z-index: 999; }
        .css-marker:hover .marker-preview-img { transform: translateX(-50%) scale(1); }
        .css-marker:hover .has-img-label { opacity: 0 !important; visibility: hidden !important; }
        .css-marker:hover .no-img-label { opacity: 1; visibility: visible; }
        .css-marker.show-text { width: 20px; height: 20px; }
        .css-marker.show-text .marker-arrow { opacity: 1; }
        .css-marker.show-text .marker-label { opacity: 1; visibility: visible; }

        /* --- å¼¹çª—æ ·å¼ --- */
        .custom-info {
            position: relative; padding: 0; background: white; border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3); width: 280px; overflow: hidden;
        }
        .info-close-btn {
            position: absolute; top: 8px; right: 8px; width: 24px; height: 24px;
            background: rgba(0,0,0,0.4); color: white; text-align: center;
            line-height: 22px; border-radius: 50%; font-size: 18px; cursor: pointer; z-index: 10;
        }
        .info-close-btn:hover { background: rgba(0,0,0,0.7); }
        .custom-info-img { width: 100%; height: 140px; object-fit: cover; display: block; }
        .custom-info-body { padding: 12px; }
        .custom-info h3 { margin: 0 0 6px 0; font-size: 16px; border-left-width: 4px; border-left-style: solid; padding-left: 8px; display: flex; align-items: center;}
        .custom-info h3 a { text-decoration: none; color: #333; display: flex; align-items: center; }
        .custom-info h3 a:hover { color: #1890ff; text-decoration: underline; }
        .link-icon-svg { width: 16px; height: 16px; margin-left: 6px; fill: #999; }
        .custom-info p { margin: 0 0 10px 0; color: #666; font-size: 13px; line-height: 1.4; }

        /* --- å¯¼èˆªæŒ‰é’®ç»„ --- */
        .nav-btn-group {
            display: flex;
            justify-content: space-between;
            border-top: 1px solid #eee;
            padding-top: 10px;
        }
        .nav-btn {
            flex: 1;
            margin: 0 4px;
            padding: 6px 0;
            border: 1px solid #1890ff;
            color: #1890ff;
            background: #fff;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            text-align: center;
            transition: all 0.2s;
        }
        .nav-btn:hover { background: #1890ff; color: white; }
        .nav-btn:first-child { margin-left: 0; }
        .nav-btn:last-child { margin-right: 0; }

        /* --- å®šä½æŒ‰é’®å¾®è°ƒ --- */
        .amap-geolocation-con .amap-geo {
            box-shadow: 0 2px 6px rgba(0,0,0,0.3); border-radius: 4px; background-color: #fff;
            width: 32px; height: 32px; border: none;
        }
        /* è°ƒæ•´å®šä½æŒ‰é’®ä½ç½®ï¼Œé˜²æ­¢è¢«åº•éƒ¨é¢æ¿é®æŒ¡ */
        .amap-geolocation-con {
            bottom: 40px !important; 
            right: 20px !important;
        }
    </style>

    <script type="text/javascript">
        window._AMapSecurityConfig = {
            securityJsCode: '6dad3452c1fdd8a908cee2623088afa5'
        }
    </script>
    <script type="text/javascript" src="https://webapi.amap.com/maps?v=2.0&key=0a20910de98845bf4c6dc64da5e505a4"></script>
</head>
<body>

    <div id="container"></div>

    <!-- ç­›é€‰é¢æ¿ -->
    <div class="control-panel collapsed" id="filterPanel">
        <div class="panel-header" onclick="togglePanel()">
            <h4>åˆ†ç±»ç­›é€‰</h4>
            <span class="toggle-icon">â–¼</span>
        </div>
        <div class="panel-content">
            <button class="filter-btn active" onclick="filterMarkers('all')"><span style="background: #333;"></span>å…¨éƒ¨æ˜¾ç¤º</button>
            <button class="filter-btn" onclick="filterMarkers('shopping')"><span style="background: #ff4d4f;"></span>é’å°‘ç´ è´¨</button>
            <button class="filter-btn" onclick="filterMarkers('history')"><span style="background: #1890ff;"></span>å†å²å¤è¿¹</button>
            <button class="filter-btn" onclick="filterMarkers('culture')"><span style="background: #52c41a;"></span>æ–‡åŒ–åœ£åœ°</button>
            <button class="filter-btn" onclick="filterMarkers('scenery')"><span style="background: #faad14;"></span>è‡ªç„¶é£å…‰</button>
        </div>
    </div>

    <!-- è·¯çº¿ç»“æœé¢æ¿ (åº•éƒ¨å¼¹å‡ºç‰ˆ) -->
    <div id="routePanel">
        <div class="route-header">
            <span class="route-title">è·¯çº¿è¯¦æƒ…</span>
            <span class="close-route-btn" onclick="closeRoutePanel()">Ã—</span>
        </div>
        <div id="routeContent"></div>
    </div>

    <script type="text/javascript">
        var map = new AMap.Map('container', {
            zoom: 12,
            center: [118.796877, 32.060255],
            viewMode: '3D'
        });

        // å…¨å±€å˜é‡
        var userPosition = null; 
        var currentRoutePlugin = null; 

        function togglePanel() {
            document.getElementById('filterPanel').classList.toggle('collapsed');
        }

        // ä¿®æ”¹åçš„å…³é—­å‡½æ•°
        function closeRoutePanel() {
            var panel = document.getElementById('routePanel');
            panel.classList.remove('active'); // ç§»é™¤ active ç±»ï¼Œè§¦å‘ä¸‹æ»‘åŠ¨ç”»
            
            // å»¶è¿Ÿæ¸…ç©ºå†…å®¹ï¼Œç­‰å¾…åŠ¨ç”»ç»“æŸ
            setTimeout(function() {
                if (currentRoutePlugin) {
                    currentRoutePlugin.clear(); 
                }
                document.getElementById('routeContent').innerHTML = '';
            }, 300);
        }

        var currentMarkers = [];
        var markersData = [
            // --- å…­åˆ ---
            { position: [118.843058,32.328519], title: "å…­åˆå¤©è¡—æ ¡åŒº", content: "å—äº¬å¸‚å…­åˆåŒºé›„å·è¡—é“æ™¯å…°è·¯2å·", category: "shopping", color: "#ff4d4f", image: "https://img.heliar.top/file/1770800822471_banner_æ‹·è´.jpg", link: "https://www.dianping.com/shop/l9bjzjzlFUlQjmL6" },
            // --- é›¨èŠ±å°åŒº ---
            { position: [118.77743,31.981767], title: "é›¨èŠ±æ ¡åŒº", content: "å—äº¬å¸‚é›¨èŠ±å°åŒºéƒé‡‘é¦™è·¯19å·ä¸œä¾§1å±‚", category: "shopping", color: "#ff4d4f", image: "", link: "https://www.dianping.com/shop/G4PXVKBK923j7k1V" },
            { position: [118.66072,31.907891], title: "æ¿æ¡¥èŠ±ç”Ÿå”æ ¡åŒº", content: "å—äº¬å¸‚é›¨èŠ±å°åŒºæ–°æ¹–å¤§é“9å·èŠ±æ ·å¹´ã€èŠ±ç”Ÿå”3å¹¢1å±‚", category: "shopping", color: "#ff4d4f", image: "", link: "https://www.dianping.com/shop/G7eFapESneJIKgtJ" },
            // --- æ±ŸåŒ—æ–°åŒº ---
            { position: [118.726544,32.137333], title: "æ¡¥åŒ—å¼˜é˜³æ ¡åŒº", content: "å—äº¬å¸‚æ±ŸåŒ—æ–°åŒºå¤§æ¡¥åŒ—è·¯48å·å¼˜é˜³å¹¿åœºA2é¦†3æ¥¼", category: "shopping", color: "#ff4d4f", image: "", link: "https://www.dianping.com/shop/l3i49yPmxvwpOc3M" },
            { position: [118.743301,32.14203], title: "æŸ³æ´²ä¸œè·¯æ ¡åŒº", content: "å—äº¬å¸‚æµ¦å£åŒºæŸ³æ´²ä¸œè·¯189å·äº¬æ–°é‚»é‡Œå¹¿åœºç¬¬äºŒå±‚", category: "shopping", color: "#ff4d4f", image: "", link: "" },
            { position: [118.76135,32.231782], title: "å¤§å‚æ…•æ–¯èŸæ ¡åŒº", content: "å—äº¬å¸‚æ±ŸåŒ—æ–°åŒºå¤§å‚è‘›å…³è·¯380-1å·æ…•æ–¯èŸ3æ¥¼", category: "shopping", color: "#ff4d4f", image: "", link: "https://www.dianping.com/shop/H2yDYLyDTHm70mqx" },
            // --- ç§¦æ·®åŒº ---
            { position: [118.781153,32.020138], title: "ä¸‰å±±è¡—æ ¡åŒº", content: "å—äº¬å¸‚ç§¦æ·®åŒºé•¿ä¹è·¯9å·2å·æ¥¼1å±‚éƒ¨åˆ†æˆ¿å±‹", category: "shopping", color: "#ff4d4f", image: "", link: "https://www.dianping.com/shop/k8GcGTvbS8rlbPjN" },
            { position: [118.808904,32.032336], title: "ç‘é‡‘è·¯æ ¡åŒº", content: "å—äº¬å¸‚ç§¦æ·®åŒºç‘é‡‘è·¯è¡—é“1æ¥¼", category: "shopping", color: "#ff4d4f", image: "", link: "https://www.dianping.com/shop/l83MvhDgf36p8ryM" },
            { position: [118.783418,32.030423], title: "å¼ åºœå›­æ ¡åŒº", content: "å—äº¬å¸‚ç§¦æ·®åŒºä¸­å±±å—è·¯344å·3F-301", category: "shopping", color: "#ff4d4f", image: "", link: "https://www.dianping.com/shop/G5PfKtD4W23QrGOq" },
            // --- æµ¦å£åŒº ---
            { position: [118.639324,32.069748], title: "æ±Ÿæµ¦æ ¡åŒº", content: "å—äº¬å¸‚æµ¦å£åŒºæµ·éƒ½è·¯8å·é‡‘ç››ç”°å¹¿åœº2F024-50å•†é“º", category: "shopping", color: "#ff4d4f", image: "", link: "https://www.dianping.com/shop/l7if713xJtkBLy5m" },
            // --- æ±Ÿå®åŒº ---
            { position: [118.84739,31.928693], title: "ç«¹å±±è·¯æ ¡åŒº", content: "å—äº¬å¸‚æ±Ÿå®åŒºç«¹å±±è·¯551å·æ¥¼EåŒº1æ¥¼å±€éƒ¨", category: "shopping", color: "#ff4d4f", image: "", link: "https://www.dianping.com/shop/H9irejNax4a6oLdt" },
            { position: [118.820852,31.931825], title: "æ±Ÿå®é‡‘é¹°æ ¡åŒº", content: "å—äº¬å¸‚æ±Ÿå®åŒºåŒé¾™å¤§é“1688å·æ±Ÿå®è´­ç‰©ä¸­å¿ƒå†…çš„A03å±‚", category: "shopping", color: "#ff4d4f", image: "", link: "https://www.dianping.com/shop/H4xm1y59ZiTUJ2mM" },
            // --- å»ºé‚ºåŒº ---
            { position: [118.737175,32.015675], title: "å…´éš†å¤§è¡—æ ¡åŒº", content: "å—äº¬å¸‚å»ºé‚ºåŒºæ±Ÿä¸œä¸­è·¯211å·ä¸‰æ¥¼", category: "shopping", color: "#ff4d4f", image: "", link: "https://www.dianping.com/shop/l6ZxfekeAjE6YokW" },
            { position: [118.722122,31.984657], title: "å¥¥ä½“é›¨æ¶¦æ ¡åŒº", content: "å—äº¬å¸‚å»ºé‚ºåŒºé›¨æ¶¦å¤§è¡—88-2å·æ²™æ´²è¡—é“æœåŠ¡ä¸­å¿ƒ3å·æ¥¼2å±‚", category: "shopping", color: "#ff4d4f", image: "", link: "https://www.dianping.com/shop/H2S9fLxtxhy1RCfm#comment" },
            { position: [118.706775,31.966875], title: "å¥¥å—é‚»é‡ŒèŒ‚æ ¡åŒº", content: "å—äº¬å¸‚å»ºé‚ºåŒºå¤ªæ¸…è·¯6å·ä¸œå—é‚»é‡ŒèŒ‚è´­ç‰©ä¸­å¿ƒF210å®¤", category: "shopping", color: "#ff4d4f", image: "", link: "" },
            // --- é¼“æ¥¼åŒº ---
            { position: [118.747977,32.047217], title: "æ¸…å‡‰é—¨æ ¡åŒº", content: "æ±Ÿè‹çœå—äº¬å¸‚æ¸…å‡‰é—¨å¤§è¡—60å·é‡Œåœ©ç¤¾åŒºæœåŠ¡ä¸­å¿ƒåŒ—åŒºäºŒå±‚", category: "shopping", color: "#ff4d4f", image: "", link: "https://www.dianping.com/shop/G1N2xGJDgVoGlhko" },
            { position: [118.77861,32.08347], title: "è®¸åºœå··æ ¡åŒº", content: "å—äº¬å¸‚é¼“æ¥¼åŒºèŠ¦å¸­è¥97å·é•¿æ±Ÿç§‘æŠ€å›­Aåº§1å±‚ã€Båº§1å±‚", category: "shopping", color: "#ff4d4f", image: "", link: "https://www.dianping.com/shop/l7STGGjmA5B5alq0#comment" },
            { position: [118.803504,32.09946], title: "è¿ˆçš‹æ¡¥æ ¡åŒº", content: "å—äº¬å¸‚é¼“æ¥¼åŒºå’Œç‡•è·¯239å·å—æ˜Œå¤§å¦ç¬¬ä¸‰å±‚æ•´å±‚", category: "shopping", color: "#ff4d4f", image: "", link: "https://www.dianping.com/shop/jMJl1pnlQv32oLig" },
            { position: [118.74049,32.044635], title: "æ¸…æ±Ÿè‹å®æ ¡åŒº", content: "æ±Ÿè‹çœå—äº¬å¸‚é¼“æ¥¼åŒºæ±Ÿä¸œåŒ—è·¯88å·æ¸…æ±Ÿå¹¿åœºè‹å®å¹¿åœº3Fã€4F", category: "shopping", color: "#ff4d4f", image: "", link: "https://www.dianping.com/shop/l45PNKo9sT131a0k#comment" },
            { position: [118.741478,32.085963], title: "é¼“æ¥¼æ»¨æ±Ÿæ ¡åŒº", content: "å—äº¬å¸‚é¼“æ¥¼åŒºçƒ­æ²³å—è·¯2å·çš„æ±Ÿè‹å›½é™…äººæ‰å…¬å¯“è£™æ¥¼Aåº§L2å±‚", category: "shopping", color: "#ff4d4f", image: "", link: "https://www.dianping.com/shop/G38afZUlzVxIyA1j#comment" },
            { position: [118.773491,32.071264], title: "é©¬å°è¡—æ ¡åŒº", content: "å—äº¬å¸‚é¼“æ¥¼åŒºé©¬å°è¡—99å·ä¸‰å±‚F311-315", category: "shopping", color: "#ff4d4f", image: "", link: "https://www.dianping.com/shop/H3bbHJLjC4bVG8bg" },
            { position: [118.742864,32.058797], title: "é¾™æ±Ÿæ ¡åŒº", content: "é¼“æ¥¼åŒºè‰åœºé—¨å¤§è¡—96å·ä¸­é’å¤§å¦1,2å·äºŒå±‚ä¸œ", category: "shopping", color: "#ff4d4f", image: "", link: "https://www.dianping.com/shop/H11YYGEV7ag2BWAy" },
            // --- ç„æ­¦åŒº ---
            { position: [118.784711,32.057818], title: "é¼“æ¥¼æ ¡åŒº", content: "ä¸­å±±è·¯366å·å—äº¬é¼“æ¥¼é‚®æ”¿å¤§å¦2æ¥¼", category: "shopping", color: "#ff4d4f", image: "", link: "https://www.dianping.com/shop/l65kImEcSwo64d2Q" },
            { position: [118.85871,32.035648], title: "å­é™µå«æ ¡åŒº", content: "å—äº¬å¸‚ç„æ­¦åŒºä¸­å±±é—¨å¤§è¡—297å·5å¹¢106/107/108/110/111/113å®¤", category: "shopping", color: "#ff4d4f", image: "", link: "https://www.dianping.com/shop/k9bEyqID1Ay9SqP8" },
            // --- æ –éœåŒº ---
            { position: [118.978879,32.130015], title: "ä»™æ—æ¹–æ ¡åŒº", content: "å—äº¬å¸‚æ –éœåŒºä»™æ—å­¦æ£®è·¯ä»™æ—æ¹–ç¤¾åŒºæœåŠ¡ä¸­å¿ƒA1æ ‹3æ¥¼", category: "shopping", color: "#ff4d4f", image: "", link: "https://www.dianping.com/shop/k76TRinqcZdQSMZn#comment" },
            { position: [118.922866,32.097065], title: "ä»™æ—é«˜ç§‘æ ¡åŒº", content: "å—äº¬å¸‚æ –éœåŒºé—²æ—è¡—é“ä»™æ—å¤§å­¦åŸå­¦æ´¥è·¯8å·é«˜åˆ›å¤§å¦äºŒæ¥¼", category: "shopping", color: "#ff4d4f", image: "", link: "https://www.dianping.com/shop/H3fe7sMTkGPhruCs" },
            // --- å…¶ä»– ---
            { position: [118.740514, 32.044607], title: "æ¸…æ±Ÿæ ¡åŒº", content: "è‹å®å¹¿åœºå››æ¥¼", category: "history", color: "#1890ff", image: "https://img.heliar.top/file/1770800822471_banner_æ‹·è´.jpg", link: "https://www.baidu.com" },
            { position: [118.788487, 32.022987], title: "å¤«å­åº™", content: "ä¸­å›½å››å¤§æ–‡åº™ä¹‹ä¸€", category: "culture", color: "#52c41a", image: "https://webapi.amap.com/theme/v1.3/markers/n/mark_r.png", link: "http://www.njfzm.net/" },
            { position: [118.79647, 32.07057], title: "ç„æ­¦æ¹–", content: "æ±Ÿå—ä¸‰å¤§åæ¹–ä¹‹ä¸€", category: "scenery", color: "#faad14", image: "https://webapi.amap.com/theme/v1.3/markers/n/mark_b.png", link: "https://baike.baidu.com" }
        ];

        var linkIconSvg = `
        <svg class="link-icon-svg" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg">
            <path d="M869 487.8L491.2 159.9c-2.9-2.5-6.6-3.9-10.5-3.9h-88.5c-7.4 0-10.8 9.2-5.2 14l350.2 304H152c-4.4 0-8 3.6-8 8v60c0 4.4 3.6 8 8 8h585.1L386.9 854c-5.6 4.9-2.2 14 5.2 14h91.5c1.9 0 3.8-0.7 5.2-2L869 536.2c14.7-12.8 14.7-35.6 0-48.4z"></path>
        </svg>
        `;

        function renderMarkers(data) {
            map.remove(currentMarkers);
            currentMarkers = [];

            data.forEach(function(item) {
                var hasImage = item.image && item.image !== "";
                var markerContent = `
                    <div class="css-marker dynamic-marker" style="background-color: ${item.color};">
                        ${hasImage ? `<img src="${item.image}" class="marker-preview-img">` : ''}
                        <span class="marker-label ${hasImage ? 'has-img-label' : 'no-img-label'}" style="border-left: 3px solid ${item.color}">${item.title}</span>
                        <div class="marker-arrow" style="border-top-color: ${item.color};"></div>
                    </div>
                `;

                var marker = new AMap.Marker({
                    position: item.position,
                    map: map,
                    content: markerContent,
                    title: item.title,
                    offset: new AMap.Pixel(-8, -8),
                    anchor: 'center'
                });

                // å¼¹çª—å†…å®¹
                var infoContent = `
                    <div class="custom-info">
                        <div class="info-close-btn" onclick="map.clearInfoWindow()">Ã—</div>
                        ${hasImage ? `<img src="${item.image}" class="custom-info-img" alt="${item.title}">` : ''}
                        <div class="custom-info-body">
                            <h3 style="border-left-color: ${item.color};">
                                <a href="${item.link}" target="_blank">
                                    ${item.title}
                                    ${linkIconSvg}
                                </a>
                            </h3>
                            <p>${item.content}</p>
                            <div class="nav-btn-group">
                                <button class="nav-btn" onclick="startNavigation('driving', ${item.position[0]}, ${item.position[1]})">ğŸš— é©¾è½¦</button>
                                <button class="nav-btn" onclick="startNavigation('transfer', ${item.position[0]}, ${item.position[1]})">ğŸšŒ å…¬äº¤</button>
                                <button class="nav-btn" onclick="startNavigation('walking', ${item.position[0]}, ${item.position[1]})">ğŸš¶ æ­¥è¡Œ</button>
                            </div>
                        </div>
                    </div>
                `;

                var infoWindow = new AMap.InfoWindow({
                    isCustom: true,
                    content: infoContent,
                    offset: new AMap.Pixel(0, -20)
                });

                marker.on('click', function() { infoWindow.open(map, marker.getPosition()); });

                currentMarkers.push(marker);
            });

            updateMarkerSize();
        }

        function filterMarkers(category) {
            event.stopPropagation();
            var buttons = document.querySelectorAll('.filter-btn');
            buttons.forEach(btn => btn.classList.remove('active'));
            event.currentTarget.classList.add('active');
            if (category === 'all') renderMarkers(markersData);
            else renderMarkers(markersData.filter(item => item.category === category));
        }

        function updateMarkerSize() {
            var zoom = map.getZoom();
            var markerDoms = document.querySelectorAll('.dynamic-marker');
            var showTextThreshold = 13.5;

            markerDoms.forEach(function(dom) {
                if (zoom >= showTextThreshold) {
                    dom.classList.add('show-text');
                } else {
                    dom.classList.remove('show-text');
                }
            });
        }

        // --- æ ¸å¿ƒåŠŸèƒ½ï¼šå¼€å§‹å¯¼èˆª ---
        function startNavigation(type, endLng, endLat) {
            if (!userPosition) {
                alert("æ­£åœ¨è·å–æ‚¨çš„ä½ç½®ï¼Œè¯·ç¨åé‡è¯•ï¼ˆè¯·ç¡®ä¿æµè§ˆå™¨å…è®¸å®šä½ï¼‰");
                // æ¨¡æ‹Ÿå®šä½æ•°æ®ç”¨äºæµ‹è¯•ï¼ˆå¦‚æœçœŸå®ç¯å¢ƒå®šä½å¤±è´¥ï¼Œå¯ä»¥è§£å¼€ä¸‹é¢æ³¨é‡Šè¿›è¡Œæµ‹è¯•ï¼‰
                // userPosition = [118.796877, 32.060255]; 
                return;
            }

            // 1. å…³é—­ä¿¡æ¯çª—ä½“
            map.clearInfoWindow();
            
            // 2. æ˜¾ç¤ºåº•éƒ¨é¢æ¿ (é€šè¿‡æ·»åŠ  class è§¦å‘åŠ¨ç”»)
            var panel = document.getElementById('routePanel');
            var titleSpan = panel.querySelector('.route-title');
            
            // è®¾ç½®æ ‡é¢˜
            var typeName = type === 'driving' ? 'é©¾è½¦' : (type === 'transfer' ? 'å…¬äº¤' : 'æ­¥è¡Œ');
            titleSpan.innerText = typeName + "è·¯çº¿è§„åˆ’";
            
            panel.classList.add('active'); 
            
            document.getElementById('routeContent').innerHTML = '<p style="color:#666;text-align:center;padding-top:20px;">æ­£åœ¨è§„åˆ’è·¯çº¿...</p>';

            // 3. æ¸…é™¤ä¹‹å‰çš„è·¯çº¿
            if (currentRoutePlugin) {
                currentRoutePlugin.clear();
            }

            var startPoint = userPosition;
            var endPoint = [endLng, endLat];

            // æ ¹æ®ç±»å‹åŠ è½½ä¸åŒçš„æ’ä»¶
            if (type === 'driving') {
                AMap.plugin('AMap.Driving', function() {
                    currentRoutePlugin = new AMap.Driving({
                        map: map,
                        panel: "routeContent", 
                        policy: AMap.DrivingPolicy.LEAST_TIME
                    });
                    currentRoutePlugin.search(startPoint, endPoint, function(status, result) {
                        if (status !== 'complete') {
                            document.getElementById('routeContent').innerHTML = '<p style="padding:15px;color:red;">è·¯çº¿è§„åˆ’å¤±è´¥: ' + result + '</p>';
                        }
                    });
                });
            } else if (type === 'transfer') {
                AMap.plugin('AMap.Transfer', function() {
                    currentRoutePlugin = new AMap.Transfer({
                        map: map,
                        panel: "routeContent",
                        city: 'å—äº¬å¸‚', 
                        policy: AMap.TransferPolicy.LEAST_TIME
                    });
                    currentRoutePlugin.search(startPoint, endPoint, function(status, result) {
                        if (status !== 'complete') {
                            document.getElementById('routeContent').innerHTML = '<p style="padding:15px;color:red;">æœªæ‰¾åˆ°åˆé€‚çš„å…¬äº¤è·¯çº¿</p>';
                        }
                    });
                });
            } else if (type === 'walking') {
                AMap.plugin('AMap.Walking', function() {
                    currentRoutePlugin = new AMap.Walking({
                        map: map,
                        panel: "routeContent"
                    });
                    currentRoutePlugin.search(startPoint, endPoint, function(status, result) {
                        if (status !== 'complete') {
                            document.getElementById('routeContent').innerHTML = '<p style="padding:15px;color:red;">è·ç¦»è¿‡è¿œï¼Œä¸å»ºè®®æ­¥è¡Œ</p>';
                        }
                    });
                });
            }
        }

        map.on('zoomchange', updateMarkerSize);
        map.on('zoomend', updateMarkerSize);

        renderMarkers(markersData);

        // --- æ’ä»¶åŠ è½½ä¸å®šä½ ---
        AMap.plugin(['AMap.ToolBar', 'AMap.Scale', 'AMap.Geolocation', 'AMap.Driving', 'AMap.Transfer', 'AMap.Walking'], function(){
            map.addControl(new AMap.ToolBar());
            map.addControl(new AMap.Scale());

            var geolocation = new AMap.Geolocation({
                enableHighAccuracy: true,
                timeout: 10000,
                buttonPosition: 'RB',
                buttonOffset: new AMap.Pixel(20, 20),
                zoomToAccuracy: false, 
                markerOptions: {
                    content: '<div style="width:16px;height:16px;background:#1890ff;border:3px solid white;border-radius:50%;box-shadow:0 0 5px rgba(0,0,0,0.5);"></div>',
                    offset: new AMap.Pixel(-8, -8)
                },
                circleOptions: {
                    strokeColor: '#1890ff',
                    strokeOpacity: 0.5,
                    strokeWeight: 1,
                    fillColor: '#1890ff',
                    fillOpacity: 0.2
                }
            });

            map.addControl(geolocation);

            // ç›‘å¬å®šä½æˆåŠŸäº‹ä»¶ï¼Œä¿å­˜ç”¨æˆ·ä½ç½®
            geolocation.getCurrentPosition(function(status, result){
                if(status=='complete'){
                    console.log('å®šä½æˆåŠŸ', result.position);
                    userPosition = [result.position.lng, result.position.lat]; 
                }else{
                    console.log('å®šä½å¤±è´¥', result);
                    alert("å®šä½å¤±è´¥ï¼Œæ— æ³•ä½¿ç”¨å¯¼èˆªåŠŸèƒ½ï¼Œè¯·æ£€æŸ¥æµè§ˆå™¨æƒé™ã€‚");
                }
            });
        });

    </script>
</body>
</html>
