<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no, width=device-width">
    <title>南京地图 - 带链接图标的矩形弹窗 - 小智</title>
    <style>
        html, body, #container {
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
            font-family: "Microsoft YaHei", sans-serif;
        }

        /* --- 控制面板样式 --- */
        .control-panel {
            position: absolute;
            top: 20px;
            left: 20px;
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.3);
            z-index: 100;
            width: 200px;
        }
        .control-panel h4 { margin: 0 0 10px 0; font-size: 16px; }
        .filter-btn {
            display: block;
            width: 100%;
            padding: 8px;
            margin-bottom: 8px;
            border: 1px solid #ddd;
            background: #f9f9f9;
            cursor: pointer;
            border-radius: 4px;
            text-align: left;
            transition: all 0.3s;
        }
        .filter-btn:hover, .filter-btn.active {
            background: #e6f7ff;
            border-color: #1890ff;
            color: #1890ff;
        }
        .filter-btn span { display: inline-block; width: 10px; height: 10px; border-radius: 50%; margin-right: 8px; }

        /* --- 弹窗样式 --- */
        .custom-info { 
            position: relative; 
            padding: 0; 
            background: white; 
            border-radius: 8px; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.3); 
            width: 260px; 
            overflow: hidden; 
        }
        
        /* 关闭按钮 */
        .info-close-btn {
            position: absolute;
            top: 8px;
            right: 8px;
            width: 24px;
            height: 24px;
            background: rgba(0,0,0,0.4);
            color: white;
            text-align: center;
            line-height: 22px;
            border-radius: 50%;
            font-size: 18px;
            cursor: pointer;
            z-index: 10;
            transition: background 0.2s;
        }
        .info-close-btn:hover { background: rgba(0,0,0,0.7); }

        .custom-info-img { width: 100%; height: 140px; object-fit: cover; display: block; }
        .custom-info-body { padding: 12px; }
        
        /* 标题样式调整 */
        .custom-info h3 { 
            margin: 0 0 8px 0; 
            font-size: 16px; 
            border-left-width: 4px; 
            border-left-style: solid; 
            padding-left: 8px; 
            display: flex; /* 使用 flex 布局让文字和图标对齐 */
            align-items: center;
        }
        
        /* 链接样式 */
        .custom-info h3 a { 
            text-decoration: none; 
            color: #333; 
            transition: color 0.2s; 
            display: flex; 
            align-items: center; /* 垂直居中 */
            cursor: pointer; 
        }
        .custom-info h3 a:hover { color: #1890ff; text-decoration: underline; }
        
        /* --- 新增：链接图标样式 --- */
        .link-icon-svg {
            width: 16px;
            height: 16px;
            margin-left: 6px;
            fill: #999; /* 默认灰色 */
            transition: fill 0.2s;
        }
        /* 鼠标悬停在链接上时，图标也变色 */
        .custom-info h3 a:hover .link-icon-svg {
            fill: #1890ff;
        }

        .custom-info p { margin: 0; color: #666; font-size: 13px; line-height: 1.5; }

        /* --- 标记点基础样式 --- */
        .css-marker {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            color: white;
            text-align: center;
            line-height: 30px;
            font-weight: bold;
            box-shadow: 0 0 10px rgba(0,0,0,0.5);
            border: 2px solid white;
            position: relative;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            transform-origin: center bottom; 
            box-sizing: border-box;
        }

        .css-marker.mini-mode {
            width: 14px !important;
            height: 14px !important;
            border-radius: 50% !important;
            border-width: 2px !important;
            font-size: 0 !important;
            line-height: 0 !important;
            box-shadow: 0 0 4px rgba(0,0,0,0.4) !important;
            transform: translateY(32px) !important; 
        }

        .css-marker.mini-mode .arrow-icon { opacity: 0; transition: opacity 0.2s; }
    </style>
    
    <script type="text/javascript">
        window._AMapSecurityConfig = {
            securityJsCode: '6dad3452c1fdd8a908cee2623088afa5' 
        }
    </script>
    <script type="text/javascript" src="https://webapi.amap.com/maps?v=2.0&key=0a20910de98845bf4c6dc64da5e505a4"></script>
</head>
<body>

<div id="container"></div>

<div class="control-panel">
    <h4>分类筛选</h4>
    <button class="filter-btn active" onclick="filterMarkers('all')"><span style="background: #333;"></span>全部显示</button>
    <button class="filter-btn" onclick="filterMarkers('shopping')"><span style="background: #ff4d4f;"></span>商业中心</button>
    <button class="filter-btn" onclick="filterMarkers('history')"><span style="background: #1890ff;"></span>历史古迹</button>
    <button class="filter-btn" onclick="filterMarkers('culture')"><span style="background: #52c41a;"></span>文化圣地</button>
    <button class="filter-btn" onclick="filterMarkers('scenery')"><span style="background: #faad14;"></span>自然风光</button>
</div>

<script type="text/javascript">
    var map = new AMap.Map('container', {
        zoom: 12, 
        center: [118.796877, 32.060255], 
        viewMode: '3D'
    });

    var currentMarkers = [];
    var markersData = [
        { position: [118.736965, 32.015245], title: "青少兴隆大街校区", content: "新东方素质成长中心", category: "shopping", color: "#ff4d4f", label: "青", image: "https://img.heliar.top/file/1770800822471_banner_拷贝.jpg", link: "https://www.dianping.com/shop/l6ZxfekeAjE6YokW" },
        { position: [118.740514, 32.044607], title: "高中清江校区", content: "苏宁广场四楼", category: "history", color: "#1890ff", label: "高", image: "https://img.heliar.top/file/1770800822471_banner_拷贝.jpg", link: "https://www.baidu.com" },
        { position: [118.788487, 32.022987], title: "夫子庙", content: "中国四大文庙之一", category: "culture", color: "#52c41a", label: "庙", image: "https://webapi.amap.com/theme/v1.3/markers/n/mark_r.png", link: "http://www.njfzm.net/" },
        { position: [118.79647, 32.07057], title: "玄武湖", content: "江南三大名湖之一", category: "scenery", color: "#faad14", label: "湖", image: "https://webapi.amap.com/theme/v1.3/markers/n/mark_b.png", link: "https://baike.baidu.com" }
    ];

    // 定义一个 SVG 图标字符串 (外部链接图标)
    var linkIconSvg = `
        <svg class="link-icon-svg" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg">
            <path d="M869 487.8L491.2 159.9c-2.9-2.5-6.6-3.9-10.5-3.9h-88.5c-7.4 0-10.8 9.2-5.2 14l350.2 304H152c-4.4 0-8 3.6-8 8v60c0 4.4 3.6 8 8 8h585.1L386.9 854c-5.6 4.9-2.2 14 5.2 14h91.5c1.9 0 3.8-0.7 5.2-2L869 536.2c14.7-12.8 14.7-35.6 0-48.4z"></path>
        </svg>
    `;

    function renderMarkers(data) {
        map.remove(currentMarkers);
        currentMarkers = [];

        data.forEach(function(item) {
            var markerContent = `
                <div class="css-marker dynamic-marker" style="background-color: ${item.color};">
                    ${item.label}
                    <div class="arrow-icon" style="
                        position: absolute; bottom: -6px; left: 50%; transform: translateX(-50%);
                        width: 0; height: 0; 
                        border-left: 6px solid transparent; border-right: 6px solid transparent;
                        border-top: 6px solid ${item.color};">
                    </div>
                </div>
            `;

            var marker = new AMap.Marker({
                position: item.position,
                map: map,
                content: markerContent,
                title: item.title,
                offset: new AMap.Pixel(-15, -35),
                anchor: 'bottom-center'
            });

            // --- 修改重点 ---
            // 在标题 <a> 标签内加入了 linkIconSvg
            var infoContent = `
                <div class="custom-info">
                    <div class="info-close-btn" onclick="map.clearInfoWindow()">×</div>
                    <img src="${item.image}" class="custom-info-img" alt="${item.title}">
                    <div class="custom-info-body">
                        <h3 style="border-left-color: ${item.color};">
                            <a href="${item.link}" target="_blank">
                                ${item.title}
                                ${linkIconSvg}
                            </a>
                        </h3>
                        <p>${item.content}</p>
                    </div>
                </div>
            `;
            
            var infoWindow = new AMap.InfoWindow({ 
                isCustom: true, 
                content: infoContent, 
                offset: new AMap.Pixel(0, -45)
            });

            marker.on('click', function() { infoWindow.open(map, marker.getPosition()); });

            currentMarkers.push(marker);
        });
        
        updateMarkerSize();
    }

    function filterMarkers(category) {
        var buttons = document.querySelectorAll('.filter-btn');
        buttons.forEach(btn => btn.classList.remove('active'));
        event.currentTarget.classList.add('active');
        if (category === 'all') renderMarkers(markersData);
        else renderMarkers(markersData.filter(item => item.category === category));
    }

    function updateMarkerSize() {
        var zoom = map.getZoom(); 
        var markerDoms = document.querySelectorAll('.dynamic-marker');
        var miniThreshold = 13;

        markerDoms.forEach(function(dom) {
            if (zoom < miniThreshold) {
                dom.classList.add('mini-mode');
                dom.style.transform = ''; 
            } else {
                dom.classList.remove('mini-mode');
                var baseZoom = 12;
                var scale = 1 + (zoom - baseZoom) * 0.15;
                if (scale < 0.6) scale = 0.6;
                if (scale > 2.0) scale = 1.5;
                dom.style.transform = `scale(${scale})`;
            }
        });
    }

    map.on('zoomchange', updateMarkerSize);
    map.on('zoomend', updateMarkerSize);

    renderMarkers(markersData);

    AMap.plugin(['AMap.ToolBar', 'AMap.Scale'], function(){
        map.addControl(new AMap.ToolBar());
        map.addControl(new AMap.Scale());
    });

</script>
</body>
</html>
