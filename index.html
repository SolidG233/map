<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no, width=device-width">
    <title>南京新东方校区分布地图</title>
    <style>
        html, body, #container {
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
            font-family: "Microsoft YaHei", sans-serif;
        }

        /* --- 控制面板样式 --- */
        .control-panel {
            position: absolute;
            top: 20px;
            left: 20px;
            background: white;
            padding: 0;
            border-radius: 8px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.3);
            z-index: 100;
            width: 200px;
            overflow: hidden;
            transition: height 0.3s ease;
        }

        .panel-header {
            padding: 15px;
            background: #fff;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid transparent;
        }
        
        .panel-header:hover { background-color: #f5f5f5; }
        .panel-header h4 { margin: 0; font-size: 16px; color: #333; }
        .toggle-icon { font-size: 12px; color: #999; transition: transform 0.3s; }
        .panel-content { padding: 0 15px 15px 15px; display: block; }
        
        .control-panel.collapsed .panel-content { display: none; }
        .control-panel.collapsed .panel-header { border-bottom: none; }
        .control-panel.collapsed .toggle-icon { transform: rotate(-90deg); }

        .filter-btn {
            display: block;
            width: 100%;
            padding: 8px;
            margin-bottom: 8px;
            border: 1px solid #ddd;
            background: #f9f9f9;
            cursor: pointer;
            border-radius: 4px;
            text-align: left;
            transition: all 0.3s;
        }
        .filter-btn:last-child { margin-bottom: 0; }
        .filter-btn:hover, .filter-btn.active {
            background: #e6f7ff;
            border-color: #1890ff;
            color: #1890ff;
        }
        .filter-btn span { display: inline-block; width: 10px; height: 10px; border-radius: 50%; margin-right: 8px; }

        /* --- 标记点基础样式 --- */
        .css-marker {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            box-shadow: 0 0 4px rgba(0,0,0,0.4);
            border: 2px solid white;
            position: relative;
            transition: all 0.2s ease;
            box-sizing: border-box;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        /* 1. 文字标签样式 */
        .marker-label {
            position: absolute;
            top: -28px; /* 文字在上方 */
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(255, 255, 255, 0.95);
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            color: #333;
            white-space: nowrap;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            border: 1px solid #eee;
            pointer-events: none; /* 让鼠标点击穿透文字，点到下面的Marker */
            
            opacity: 0; 
            visibility: hidden;
            transition: opacity 0.2s, visibility 0.2s;
            font-weight: bold;
            z-index: 10;
        }

        /* 2. 悬停图片预览样式 (新增功能) */
        .marker-preview-img {
            position: absolute;
            bottom: 24px; /* 图片在点上方 */
            left: 50%;
            transform: translateX(-50%) scale(0); /* 默认缩小隐藏 */
            width: 100px; /* 预览图宽度 */
            height: 70px; /* 预览图高度 */
            object-fit: cover;
            border-radius: 6px;
            border: 2px solid white;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            background: #fff;
            z-index: 20; /* 层级最高，盖住文字 */
            transition: transform 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275); /* 弹性弹出效果 */
            transform-origin: bottom center;
            pointer-events: none;
        }

        /* 标记点下方的小箭头 */
        .marker-arrow {
            position: absolute;
            bottom: -5px;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 0;
            border-left: 5px solid transparent;
            border-right: 5px solid transparent;
            border-top-width: 5px;
            border-top-style: solid;
            opacity: 0;
            transition: opacity 0.2s;
        }

        /* --- 交互状态控制 --- */
        
        /* 状态A: 鼠标悬停时 */
        .css-marker:hover {
            transform: scale(1.2) !important;
            z-index: 999;
        }
        
        /* 悬停时：如果有图片，显示图片；如果没有图片，显示文字 */
        .css-marker:hover .marker-preview-img {
            transform: translateX(-50%) scale(1); /* 图片弹出 */
        }
        
        /* 悬停时：如果显示了图片，就把文字隐藏掉，防止重叠难看 */
        .css-marker:hover .has-img-label {
            opacity: 0 !important; 
            visibility: hidden !important;
        }
        
        /* 悬停时：如果没有图片，务必显示文字 */
        .css-marker:hover .no-img-label {
            opacity: 1;
            visibility: visible;
        }


        /* 状态B: 地图放大模式 (Zoom > 13.5) */
        .css-marker.show-text {
            width: 20px;
            height: 20px;
        }
        .css-marker.show-text .marker-arrow {
            opacity: 1;
        }
        /* 放大时显示文字 */
        .css-marker.show-text .marker-label {
            opacity: 1;
            visibility: visible;
        }

        /* --- 弹窗样式 (点击后的大图) --- */
        .custom-info { 
            position: relative; 
            padding: 0; 
            background: white; 
            border-radius: 8px; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.3); 
            width: 280px; 
            overflow: hidden; 
        }
        .info-close-btn {
            position: absolute; top: 8px; right: 8px; width: 24px; height: 24px;
            background: rgba(0,0,0,0.4); color: white; text-align: center;
            line-height: 22px; border-radius: 50%; font-size: 18px; cursor: pointer; z-index: 10;
        }
        .info-close-btn:hover { background: rgba(0,0,0,0.7); }
        .custom-info-img { width: 100%; height: 160px; object-fit: cover; display: block; }
        .custom-info-body { padding: 15px; }
        .custom-info h3 { margin: 0 0 8px 0; font-size: 16px; border-left-width: 4px; border-left-style: solid; padding-left: 8px; display: flex; align-items: center;}
        .custom-info h3 a { text-decoration: none; color: #333; display: flex; align-items: center; }
        .custom-info h3 a:hover { color: #1890ff; text-decoration: underline; }
        .link-icon-svg { width: 16px; height: 16px; margin-left: 6px; fill: #999; }
        .custom-info h3 a:hover .link-icon-svg { fill: #1890ff; }
        .custom-info p { margin: 0; color: #666; font-size: 13px; line-height: 1.5; }

        /* --- 定位按钮样式微调 (覆盖高德默认样式) --- */
        .amap-geolocation-con .amap-geo {
            box-shadow: 0 2px 6px rgba(0,0,0,0.3);
            border-radius: 4px;
            background-color: #fff;
            width: 32px;
            height: 32px;
            border: none;
        }
    </style>
    
    <script type="text/javascript">
        window._AMapSecurityConfig = {
            securityJsCode: '6dad3452c1fdd8a908cee2623088afa5' 
        }
    </script>
    <script type="text/javascript" src="https://webapi.amap.com/maps?v=2.0&key=0a20910de98845bf4c6dc64da5e505a4"></script>
</head>
<body>

<div id="container"></div>

<div class="control-panel collapsed" id="filterPanel">
    <div class="panel-header" onclick="togglePanel()">
        <h4>分类筛选</h4>
        <span class="toggle-icon">▼</span>
    </div>
    <div class="panel-content">
        <button class="filter-btn active" onclick="filterMarkers('all')"><span style="background: #333;"></span>全部显示</button>
        <button class="filter-btn" onclick="filterMarkers('shopping')"><span style="background: #ff4d4f;"></span>青少素质</button>
        <button class="filter-btn" onclick="filterMarkers('history')"><span style="background: #1890ff;"></span>历史古迹</button>
        <button class="filter-btn" onclick="filterMarkers('culture')"><span style="background: #52c41a;"></span>文化圣地</button>
        <button class="filter-btn" onclick="filterMarkers('scenery')"><span style="background: #faad14;"></span>自然风光</button>
    </div>
</div>

<script type="text/javascript">
    var map = new AMap.Map('container', {
        zoom: 12, 
        center: [118.796877, 32.060255], 
        viewMode: '3D'
    });

    function togglePanel() {
        var panel = document.getElementById('filterPanel');
        panel.classList.toggle('collapsed');
    }

    var currentMarkers = [];
    var markersData = [
        // --- 六合 ---
        { position: [118.843058,32.328519], title: "六合天街校区", content: "南京市六合区雄州街道景兰路2号", category: "shopping", color: "#ff4d4f", image: "https://img.heliar.top/file/1770800822471_banner_拷贝.jpg", link: "https://www.dianping.com/shop/l9bjzjzlFUlQjmL6" },
        // --- 雨花台区 ---
        { position: [118.77743,31.981767], title: "雨花校区", content: "南京市雨花台区郁金香路19号东侧1层", category: "shopping", color: "#ff4d4f", image: "", link: "https://www.dianping.com/shop/G4PXVKBK923j7k1V" },
        { position: [118.66072,31.907891], title: "板桥花生唐校区", content: "南京市雨花台区新湖大道9号花样年、花生唐3幢1层", category: "shopping", color: "#ff4d4f", image: "", link: "https://www.dianping.com/shop/G7eFapESneJIKgtJ" },
        // --- 江北新区 ---
        { position: [118.726544,32.137333], title: "桥北弘阳校区", content: "南京市江北新区大桥北路48号弘阳广场A2馆3楼", category: "shopping", color: "#ff4d4f", image: "", link: "https://www.dianping.com/shop/l3i49yPmxvwpOc3M" },
        { position: [118.743301,32.14203], title: "柳洲东路校区", content: "南京市浦口区柳洲东路189号京新邻里广场第二层", category: "shopping", color: "#ff4d4f", image: "", link: "" },
        { position: [118.76135,32.231782], title: "大厂慕斯荟校区", content: "南京市江北新区大厂葛关路380-1号慕斯荟3楼", category: "shopping", color: "#ff4d4f", image: "", link: "https://www.dianping.com/shop/H2yDYLyDTHm70mqx" },
        // --- 秦淮区 ---
        { position: [118.781153,32.020138], title: "三山街校区", content: "南京市秦淮区长乐路9号2号楼1层部分房屋", category: "shopping", color: "#ff4d4f", image: "", link: "https://www.dianping.com/shop/k8GcGTvbS8rlbPjN" },
        { position: [118.808904,32.032336], title: "瑞金路校区", content: "南京市秦淮区瑞金路街道1楼", category: "shopping", color: "#ff4d4f", image: "", link: "https://www.dianping.com/shop/l83MvhDgf36p8ryM" },
        { position: [118.783418,32.030423], title: "张府园校区", content: "南京市秦淮区中山南路344号3F-301", category: "shopping", color: "#ff4d4f", image: "", link: "https://www.dianping.com/shop/G5PfKtD4W23QrGOq" },
        // --- 浦口区 ---
        { position: [118.639324,32.069748], title: "江浦校区", content: "南京市浦口区海都路8号金盛田广场2F024-50商铺", category: "shopping", color: "#ff4d4f", image: "", link: "https://www.dianping.com/shop/l7if713xJtkBLy5m" },
        // --- 江宁区 ---
        { position: [118.84739,31.928693], title: "竹山路校区", content: "南京市江宁区竹山路551号楼E区1楼局部", category: "shopping", color: "#ff4d4f", image: "", link: "https://www.dianping.com/shop/H9irejNax4a6oLdt" },
        { position: [118.820852,31.931825], title: "江宁金鹰校区", content: "南京市江宁区双龙大道1688号江宁购物中心内的A03层", category: "shopping", color: "#ff4d4f", image: "", link: "https://www.dianping.com/shop/H4xm1y59ZiTUJ2mM" },
        // --- 建邺区 ---
        { position: [118.737175,32.015675], title: "兴隆大街校区", content: "南京市建邺区江东中路211号三楼", category: "shopping", color: "#ff4d4f", image: "", link: "https://www.dianping.com/shop/l6ZxfekeAjE6YokW" },
        { position: [118.722122,31.984657], title: "奥体雨润校区", content: "南京市建邺区雨润大街88-2号沙洲街道服务中心3号楼2层", category: "shopping", color: "#ff4d4f", image: "", link: "https://www.dianping.com/shop/H2S9fLxtxhy1RCfm#comment" },
        { position: [118.706775,31.966875], title: "奥南邻里茂校区", content: "南京市建邺区太清路6号东南邻里茂购物中心F210室", category: "shopping", color: "#ff4d4f", image: "", link: "" },
        // --- 鼓楼区 ---
        { position: [118.747977,32.047217], title: "清凉门校区", content: "江苏省南京市清凉门大街60号里圩社区服务中心北区二层", category: "shopping", color: "#ff4d4f", image: "", link: "https://www.dianping.com/shop/G1N2xGJDgVoGlhko" },
        { position: [118.77861,32.08347], title: "许府巷校区", content: "南京市鼓楼区芦席营97号长江科技园A座1层、B座1层", category: "shopping", color: "#ff4d4f", image: "", link: "https://www.dianping.com/shop/l7STGGjmA5B5alq0#comment" },
        { position: [118.803504,32.09946], title: "迈皋桥校区", content: "南京市鼓楼区和燕路239号南昌大厦第三层整层", category: "shopping", color: "#ff4d4f", image: "", link: "https://www.dianping.com/shop/jMJl1pnlQv32oLig" },
        { position: [118.74049,32.044635], title: "清江苏宁校区", content: "江苏省南京市鼓楼区江东北路88号清江广场苏宁广场3F、4F", category: "shopping", color: "#ff4d4f", image: "", link: "https://www.dianping.com/shop/l45PNKo9sT131a0k#comment" },
        { position: [118.741478,32.085963], title: "鼓楼滨江校区", content: "南京市鼓楼区热河南路2号的江苏国际人才公寓裙楼A座L2层", category: "shopping", color: "#ff4d4f", image: "", link: "https://www.dianping.com/shop/G38afZUlzVxIyA1j#comment" },
        { position: [118.773491,32.071264], title: "马台街校区", content: "南京市鼓楼区马台街99号三层F311-315", category: "shopping", color: "#ff4d4f", image: "", link: "https://www.dianping.com/shop/H3bbHJLjC4bVG8bg" },
        { position: [118.742864,32.058797], title: "龙江校区", content: "鼓楼区草场门大街96号中青大厦1,2号二层东", category: "shopping", color: "#ff4d4f", image: "", link: "https://www.dianping.com/shop/H11YYGEV7ag2BWAy" },
        // --- 玄武区 ---
        { position: [118.784711,32.057818], title: "鼓楼校区", content: "中山路366号南京鼓楼邮政大厦2楼", category: "shopping", color: "#ff4d4f", image: "", link: "https://www.dianping.com/shop/l65kImEcSwo64d2Q" },
        { position: [118.85871,32.035648], title: "孝陵卫校区", content: "南京市玄武区中山门大街297号5幢106/107/108/110/111/113室", category: "shopping", color: "#ff4d4f", image: "", link: "https://www.dianping.com/shop/k9bEyqID1Ay9SqP8" },
        // --- 栖霞区 ---
        { position: [118.978879,32.130015], title: "仙林湖校区", content: "南京市栖霞区仙林学森路仙林湖社区服务中心A1栋3楼", category: "shopping", color: "#ff4d4f", image: "", link: "https://www.dianping.com/shop/k76TRinqcZdQSMZn#comment" },
        { position: [118.922866,32.097065], title: "仙林高科校区", content: "南京市栖霞区闲林街道仙林大学城学津路8号高创大厦二楼", category: "shopping", color: "#ff4d4f", image: "", link: "https://www.dianping.com/shop/H3fe7sMTkGPhruCs" },
        // --- 其他 ---
        { position: [118.740514, 32.044607], title: "清江校区", content: "苏宁广场四楼", category: "history", color: "#1890ff", image: "https://img.heliar.top/file/1770800822471_banner_拷贝.jpg", link: "https://www.baidu.com" },
        { position: [118.788487, 32.022987], title: "夫子庙", content: "中国四大文庙之一", category: "culture", color: "#52c41a", image: "https://webapi.amap.com/theme/v1.3/markers/n/mark_r.png", link: "http://www.njfzm.net/" },
        { position: [118.79647, 32.07057], title: "玄武湖", content: "江南三大名湖之一", category: "scenery", color: "#faad14", image: "https://webapi.amap.com/theme/v1.3/markers/n/mark_b.png", link: "https://baike.baidu.com" }
    ];

    var linkIconSvg = `
        <svg class="link-icon-svg" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg">
            <path d="M869 487.8L491.2 159.9c-2.9-2.5-6.6-3.9-10.5-3.9h-88.5c-7.4 0-10.8 9.2-5.2 14l350.2 304H152c-4.4 0-8 3.6-8 8v60c0 4.4 3.6 8 8 8h585.1L386.9 854c-5.6 4.9-2.2 14 5.2 14h91.5c1.9 0 3.8-0.7 5.2-2L869 536.2c14.7-12.8 14.7-35.6 0-48.4z"></path>
        </svg>
    `;

    function renderMarkers(data) {
        map.remove(currentMarkers);
        currentMarkers = [];

        data.forEach(function(item) {
            // 判断是否有图片
            var hasImage = item.image && item.image !== "";
            
            // 构建 Marker 的 HTML
            var markerContent = `
                <div class="css-marker dynamic-marker" style="background-color: ${item.color};">
                    ${hasImage ? `<img src="${item.image}" class="marker-preview-img">` : ''}
                    <span class="marker-label ${hasImage ? 'has-img-label' : 'no-img-label'}" style="border-left: 3px solid ${item.color}">${item.title}</span>
                    <div class="marker-arrow" style="border-top-color: ${item.color};"></div>
                </div>
            `;

            var marker = new AMap.Marker({
                position: item.position,
                map: map,
                content: markerContent,
                title: item.title,
                offset: new AMap.Pixel(-8, -8),
                anchor: 'center'
            });

            // 点击后的详细弹窗 (保留大图)
            var infoContent = `
                <div class="custom-info">
                    <div class="info-close-btn" onclick="map.clearInfoWindow()">×</div>
                    ${hasImage ? `<img src="${item.image}" class="custom-info-img" alt="${item.title}">` : ''}
                    <div class="custom-info-body">
                        <h3 style="border-left-color: ${item.color};">
                            <a href="${item.link}" target="_blank">
                                ${item.title}
                                ${linkIconSvg}
                            </a>
                        </h3>
                        <p>${item.content}</p>
                    </div>
                </div>
            `;
            
            var infoWindow = new AMap.InfoWindow({ 
                isCustom: true, 
                content: infoContent, 
                offset: new AMap.Pixel(0, -20)
            });

            marker.on('click', function() { infoWindow.open(map, marker.getPosition()); });

            currentMarkers.push(marker);
        });
        
        updateMarkerSize();
    }

    function filterMarkers(category) {
        event.stopPropagation(); 
        var buttons = document.querySelectorAll('.filter-btn');
        buttons.forEach(btn => btn.classList.remove('active'));
        event.currentTarget.classList.add('active');
        if (category === 'all') renderMarkers(markersData);
        else renderMarkers(markersData.filter(item => item.category === category));
    }

    function updateMarkerSize() {
        var zoom = map.getZoom(); 
        var markerDoms = document.querySelectorAll('.dynamic-marker');
        var showTextThreshold = 13.5; 

        markerDoms.forEach(function(dom) {
            if (zoom >= showTextThreshold) {
                dom.classList.add('show-text');
            } else {
                dom.classList.remove('show-text');
            }
        });
    }

    map.on('zoomchange', updateMarkerSize);
    map.on('zoomend', updateMarkerSize);

    renderMarkers(markersData);

    // --- 修改部分：引入定位插件 ---
    AMap.plugin(['AMap.ToolBar', 'AMap.Scale', 'AMap.Geolocation'], function(){
        map.addControl(new AMap.ToolBar());
        map.addControl(new AMap.Scale());

        // 初始化定位插件
        var geolocation = new AMap.Geolocation({
            enableHighAccuracy: true, // 是否使用高精度定位，默认:true
            timeout: 10000,           // 超过10秒后停止定位，默认：5s
            buttonPosition: 'RB',     // 定位按钮的停靠位置 (RB表示右下角)
            buttonOffset: new AMap.Pixel(20, 20), // 定位按钮与设置的停靠位置的偏移量
            zoomToAccuracy: true,     // 定位成功后是否自动调整地图视野到定位点
            
            // 自定义定位点样式 (圆点 + 精度圈)
            markerOptions: {
                content: '<div style="width:16px;height:16px;background:#1890ff;border:3px solid white;border-radius:50%;box-shadow:0 0 5px rgba(0,0,0,0.5);"></div>',
                offset: new AMap.Pixel(-8, -8)
            },
            circleOptions: {
                strokeColor: '#1890ff',
                strokeOpacity: 0.5,
                strokeWeight: 1,
                fillColor: '#1890ff',
                fillOpacity: 0.2
            }
        });
        
        map.addControl(geolocation);
        
        // 页面加载完成后自动定位一次
        geolocation.getCurrentPosition(function(status,result){
            if(status=='complete'){
                console.log('定位成功');
            }else{
                console.log('定位失败', result);
            }
        });
    });

</script>
</body>
</html>
